# CI pipeline that runs Selenium tests on every push/PR to main
# Tests run in headless Chrome, results go to Slack + Email with failure + skipped details

name: Selenium CI Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Selenium Tests
    runs-on: ubuntu-latest

    steps:
      # Get the code from the repo
      - name: Checkout code
        uses: actions/checkout@v4

      # Install Java 17 (matches our local Maven setup)
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: maven

      # Make sure Chrome is available for Selenium
      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      # Print versions so we can debug if something breaks
      - name: Verify environment
        run: |
          java -version
          mvn -version
          google-chrome --version

      # Run all tests ‚Äî continue even if some fail so we can still report results
      - name: Run Selenium tests
        id: run_tests
        continue-on-error: true
        run: mvn clean test

      # Parse XML report for pass/fail/skipped counts and extract details
      - name: Capture test results
        if: always()
        id: test_results
        run: |
          REPORT_FILE="target/surefire-reports/TEST-com.hasby.newsletter.tests.NewsletterSignupTest.xml"

          if [ -f "$REPORT_FILE" ]; then
            TESTS=$(grep -oP 'tests="\K[^"]+' "$REPORT_FILE" | head -1)
            FAILURES=$(grep -oP 'failures="\K[^"]+' "$REPORT_FILE" | head -1)
            ERRORS=$(grep -oP 'errors="\K[^"]+' "$REPORT_FILE" | head -1)
            SKIPPED=$(grep -oP 'skipped="\K[^"]+' "$REPORT_FILE" | head -1)
            PASSED=$((TESTS - FAILURES - ERRORS - SKIPPED))

            # Extract failed AND skipped test details
            python3 << 'PYEOF'
          import xml.etree.ElementTree as ET

          tree = ET.parse("target/surefire-reports/TEST-com.hasby.newsletter.tests.NewsletterSignupTest.xml")
          root = tree.getroot()

          failures = []
          skipped_tests = []

          for tc in root.findall('.//testcase'):
              name = tc.get('name', 'Unknown')

              # Check for failures
              failure = tc.find('failure')
              if failure is not None:
                  msg = failure.get('message', 'No message')
                  if len(msg) > 300:
                      msg = msg[:300] + '...'
                  failures.append(f"‚Ä¢ {name}\n  {msg}")

              # Check for skipped/disabled
              skipped = tc.find('skipped')
              if skipped is not None:
                  msg = skipped.get('message', 'No reason provided')
                  if len(msg) > 300:
                      msg = msg[:300] + '...'
                  skipped_tests.append(f"‚Ä¢ {name}\n  Reason: {msg}")

          with open('/tmp/failure_details.txt', 'w') as f:
              f.write('\n\n'.join(failures) if failures else 'No failures')

          with open('/tmp/skipped_details.txt', 'w') as f:
              f.write('\n\n'.join(skipped_tests) if skipped_tests else 'No skipped tests')
          PYEOF
          else
            TESTS="?"
            FAILURES="?"
            ERRORS="?"
            SKIPPED="?"
            PASSED="?"
            echo "Could not parse test report" > /tmp/failure_details.txt
            echo "Could not parse test report" > /tmp/skipped_details.txt
          fi

          echo "total=$TESTS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

          if [ "${{ steps.run_tests.outcome }}" == "success" ]; then
            echo "status=PASSED ‚úÖ" >> $GITHUB_OUTPUT
          else
            echo "status=FAILED ‚ùå" >> $GITHUB_OUTPUT
          fi

      # Save Allure results (downloadable from GitHub Actions ‚Äî contains screenshots)
      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results/
          retention-days: 30

      # Save Maven test reports
      - name: Upload Surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
          retention-days: 30

      # Send Slack notification on SUCCESS
      - name: Notify Slack (Success)
        if: always() && steps.run_tests.outcome == 'success'
        shell: bash
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          COMMIT_MSG: ${{ github.event.head_commit.message || 'PR event' }}
          TOTAL: ${{ steps.test_results.outputs.total }}
          PASSED: ${{ steps.test_results.outputs.passed }}
          FAILURES: ${{ steps.test_results.outputs.failures }}
          SKIPPED: ${{ steps.test_results.outputs.skipped }}
        run: |
          # Read skipped details if any
          SKIP_DETAILS="No skipped tests"
          if [ -f /tmp/skipped_details.txt ] && [ "$SKIPPED" -gt 0 ] 2>/dev/null; then
            SKIP_RAW=$(cat /tmp/skipped_details.txt | head -20)
            SKIP_DETAILS=$(echo "$SKIP_RAW" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))" | sed 's/^"//;s/"$//')
          fi

          # Build JSON payload in a file to avoid escaping issues
          cat > /tmp/slack_payload.json << JSONEOF
          {
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "‚úÖ All Tests Passed" }
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Repository:*\n${REPO}" },
                  { "type": "mrkdwn", "text": "*Branch:*\n${BRANCH}" },
                  { "type": "mrkdwn", "text": "*Triggered by:*\n${ACTOR}" },
                  { "type": "mrkdwn", "text": "*Commit:*\n${COMMIT_MSG}" }
                ]
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Total:* ${TOTAL}" },
                  { "type": "mrkdwn", "text": "*Passed:* ${PASSED}" },
                  { "type": "mrkdwn", "text": "*Failed:* ${FAILURES}" },
                  { "type": "mrkdwn", "text": "*Skipped:* ${SKIPPED}" }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚è≠Ô∏è Skipped/Disabled Tests:*\n\`\`\`${SKIP_DETAILS}\`\`\`"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": { "type": "plain_text", "text": "View Run Details" },
                    "url": "${RUN_URL}"
                  }
                ]
              }
            ]
          }
          JSONEOF

          echo "Sending Slack notification..."
          RESPONSE=$(curl -s -o /tmp/slack_response.txt -w "%{http_code}" \
            -X POST "$SLACK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @/tmp/slack_payload.json)

          echo "Slack response code: $RESPONSE"
          echo "Slack response body: $(cat /tmp/slack_response.txt)"

      # Send Slack notification on FAILURE ‚Äî includes failed + skipped test details
      - name: Notify Slack (Failure with Bug Details)
        if: always() && steps.run_tests.outcome == 'failure'
        shell: bash
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          COMMIT_MSG: ${{ github.event.head_commit.message || 'PR event' }}
          TOTAL: ${{ steps.test_results.outputs.total }}
          PASSED: ${{ steps.test_results.outputs.passed }}
          FAILURES: ${{ steps.test_results.outputs.failures }}
          ERRORS: ${{ steps.test_results.outputs.errors }}
          SKIPPED: ${{ steps.test_results.outputs.skipped }}
        run: |
          # Read failure details
          FAIL_DETAILS="No failures"
          if [ -f /tmp/failure_details.txt ]; then
            FAIL_RAW=$(cat /tmp/failure_details.txt | head -20)
            FAIL_DETAILS=$(echo "$FAIL_RAW" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))" | sed 's/^"//;s/"$//')
          fi

          # Read skipped details
          SKIP_DETAILS="No skipped tests"
          if [ -f /tmp/skipped_details.txt ] && [ "$SKIPPED" -gt 0 ] 2>/dev/null; then
            SKIP_RAW=$(cat /tmp/skipped_details.txt | head -20)
            SKIP_DETAILS=$(echo "$SKIP_RAW" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))" | sed 's/^"//;s/"$//')
          fi

          # Build JSON payload in a file to avoid escaping issues
          cat > /tmp/slack_payload.json << JSONEOF
          {
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "‚ùå Tests Failed ‚Äî Bug Report" }
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Repository:*\n${REPO}" },
                  { "type": "mrkdwn", "text": "*Branch:*\n${BRANCH}" },
                  { "type": "mrkdwn", "text": "*Triggered by:*\n${ACTOR}" },
                  { "type": "mrkdwn", "text": "*Commit:*\n${COMMIT_MSG}" }
                ]
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Total:* ${TOTAL}" },
                  { "type": "mrkdwn", "text": "*Passed:* ${PASSED}" },
                  { "type": "mrkdwn", "text": "*Failed:* ${FAILURES}" },
                  { "type": "mrkdwn", "text": "*Skipped:* ${SKIPPED}" }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üêõ Failed Test Details:*\n\`\`\`${FAIL_DETAILS}\`\`\`"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚è≠Ô∏è Skipped/Disabled Tests:*\n\`\`\`${SKIP_DETAILS}\`\`\`"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "üì∏ *Screenshots available* in the Allure report artifact."
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": { "type": "plain_text", "text": "üìã View Full Report" },
                    "url": "${RUN_URL}"
                  }
                ]
              }
            ]
          }
          JSONEOF

          echo "Sending Slack notification..."
          RESPONSE=$(curl -s -o /tmp/slack_response.txt -w "%{http_code}" \
            -X POST "$SLACK_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @/tmp/slack_payload.json)

          echo "Slack response code: $RESPONSE"
          echo "Slack response body: $(cat /tmp/slack_response.txt)"

      # Build the email HTML body with full details from test result files
      - name: Build email body
        if: always()
        shell: bash
        env:
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          COMMIT_MSG: ${{ github.event.head_commit.message || 'PR event' }}
          ACTOR: ${{ github.actor }}
          TOTAL: ${{ steps.test_results.outputs.total }}
          PASSED: ${{ steps.test_results.outputs.passed }}
          FAILURES: ${{ steps.test_results.outputs.failures }}
          ERRORS: ${{ steps.test_results.outputs.errors }}
          SKIPPED: ${{ steps.test_results.outputs.skipped }}
          STATUS: ${{ steps.test_results.outputs.status }}
          OUTCOME: ${{ steps.run_tests.outcome }}
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RUN_NUMBER: ${{ github.run_number }}
          SHA: ${{ github.sha }}
        run: |
          # Read details from files
          FAIL_DETAILS=$(cat /tmp/failure_details.txt 2>/dev/null || echo "Could not read failure details")
          SKIP_DETAILS=$(cat /tmp/skipped_details.txt 2>/dev/null || echo "Could not read skipped details")

          # Escape HTML special characters
          FAIL_HTML=$(echo "$FAIL_DETAILS" | python3 -c "import sys,html; print(html.escape(sys.stdin.read()))")
          SKIP_HTML=$(echo "$SKIP_DETAILS" | python3 -c "import sys,html; print(html.escape(sys.stdin.read()))")
          COMMIT_HTML=$(echo "$COMMIT_MSG" | python3 -c "import sys,html; print(html.escape(sys.stdin.read()))")

          # Set colors based on outcome
          if [ "$OUTCOME" == "success" ]; then
            STATUS_COLOR="#28a745"
          else
            STATUS_COLOR="#dc3545"
          fi

          # Build the full HTML email
          cat > /tmp/email_body.html << HTMLEOF
          <html>
          <body style="font-family: Arial, sans-serif; max-width: 650px; margin: 0 auto; padding: 20px;">
            <h2 style="color: ${STATUS_COLOR};">${STATUS}</h2>

            <table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
              <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Repository</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${REPO}</td></tr>
              <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Branch</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${BRANCH}</td></tr>
              <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Commit</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${COMMIT_HTML}</td></tr>
              <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Triggered by</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${ACTOR}</td></tr>
            </table>

            <h3>Test Results</h3>
            <table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
              <tr style="background: #f5f5f5;">
                <th style="padding: 8px; border: 1px solid #ddd;">Total</th>
                <th style="padding: 8px; border: 1px solid #ddd; color: green;">Passed</th>
                <th style="padding: 8px; border: 1px solid #ddd; color: red;">Failed</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Errors</th>
                <th style="padding: 8px; border: 1px solid #ddd; color: orange;">Skipped</th>
              </tr>
              <tr style="text-align: center;">
                <td style="padding: 8px; border: 1px solid #ddd;">${TOTAL}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">${PASSED}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">${FAILURES}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">${ERRORS}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">${SKIPPED}</td>
              </tr>
            </table>

            <h3>üêõ Failed Test Details</h3>
            <pre style="background: #f8f8f8; padding: 16px; border-radius: 4px; overflow-x: auto; font-size: 12px; border: 1px solid #ddd; white-space: pre-wrap;">${FAIL_HTML}</pre>

            <h3>‚è≠Ô∏è Skipped/Disabled Tests</h3>
            <pre style="background: #fff8e1; padding: 16px; border-radius: 4px; overflow-x: auto; font-size: 12px; border: 1px solid #ffe082; white-space: pre-wrap;">${SKIP_HTML}</pre>

            <p>üì∏ <strong>Screenshots</strong> are available in the Allure report artifact.</p>

            <p>
              <a href="${RUN_URL}"
                 style="display: inline-block; background: #0366d6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">
                View Full Report &amp; Download Artifacts
              </a>
            </p>

            <hr style="margin: 24px 0;">
            <p style="color: #666; font-size: 12px;">
              Automated report from GitHub Actions CI pipeline<br>
              Run #${RUN_NUMBER} | ${SHA}
            </p>
          </body>
          </html>
          HTMLEOF

          echo "Email body built successfully"

      # Send detailed email notification using the built HTML file
      - name: Notify via Email
        if: always()
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.EMAIL_APP_PASSWORD }}
          subject: "CI Report: ${{ steps.test_results.outputs.status }} - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "CI Test Bot <${{ secrets.NOTIFICATION_EMAIL }}>"
          html_body: file:///tmp/email_body.html

      # Mark pipeline as failed if tests failed (shows red X on GitHub)
      - name: Check test outcome
        if: steps.run_tests.outcome == 'failure'
        run: |
          echo "::error::Some tests failed. Check Allure report for details."
          exit 1